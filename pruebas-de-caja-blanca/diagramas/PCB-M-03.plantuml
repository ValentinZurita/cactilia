@startuml
!theme plain
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName Arial
skinparam ArrowFontSize 11

start
note right
  Función calculateShippingDetails
  Calcula el costo de envío según regla y productos
end note

' 1 - Decisión 1
if (¿rule y products válidos?) then (No)
  ' 2
  :2. Retornar valores por defecto;
  note right: { cost: 0, minDays: null, maxDays: null, isFree: false }
  stop
endif

' 3
:3. Calcular subtotal de productos;
note right
  subtotal = suma de (precio * cantidad) de cada producto
end note

' 4
:4. Inicializar cost y isFree;
note right
  cost = precio_base de la regla
  isFree = envío gratuito configurado en la regla
end note

' 5
:5. Calcular peso total de productos;

' 6 - Decisión 2
if (¿Existe configuración de paquetes?) then (Sí)
  ' 7 - Decisión 3
  if (¿Hay peso máximo y costo por kg extra?) then (Sí)
    ' 8 - Decisión 4
    if (¿Peso total > peso máximo?) then (Sí)
      ' 9
      :9. Calcular costo extra por peso;
      :10. Añadir costo extra al costo base;
    endif
  endif
  
  ' 11 - Decisión 5
  if (¿Hay máximo de productos y costo por producto extra?) then (Sí)
    ' 12 - Decisión 6
    if (¿Cantidad de productos > máximo?) then (Sí)
      ' 13
      :13. Calcular costo extra por productos;
      :14. Añadir costo extra al costo base;
    endif
  endif
endif

' 15
:15. Obtener tiempos de entrega de la regla;

' 16 - Decisión 7
if (¿Existen opciones de mensajería?) then (Sí)
  ' 17
  :17. Ordenar opciones por precio;
  :18. Seleccionar opción más económica;
  :19. Actualizar cost con precio de la opción;
  
  ' 20 - Decisión 8
  if (¿Opción tiene configuración de paquetes?) then (Sí)
    ' 21 - Decisión 9
    if (¿Hay peso máximo y costo por kg extra?) then (Sí)
      ' 22 - Decisión 10
      if (¿Peso total > peso máximo?) then (Sí)
        ' 23
        :23. Calcular costo extra por peso;
        :24. Añadir costo extra al costo base;
      endif
    endif
    
    ' 25 - Decisión 11
    if (¿Hay máximo de productos y costo por producto extra?) then (Sí)
      ' 26 - Decisión 12
      if (¿Cantidad de productos > máximo?) then (Sí)
        ' 27
        :27. Calcular costo extra por productos;
        :28. Añadir costo extra al costo base;
      endif
    endif
  endif
  
  ' 29
  :29. Actualizar tiempos de entrega con valores de la opción;
endif

' 30 - Decisión 13
if (¿Aplica envío gratis por monto mínimo?) then (Sí)
  ' 31 - Decisión 14
  if (¿subtotal >= monto mínimo?) then (Sí)
    ' 32
    :32. Establecer isFree = true;
  endif
endif

' 33 - Decisión 15
if (¿isFree es true?) then (Sí)
  ' 34
  :34. Establecer cost = 0;
endif

' 35
:35. Normalizar valores de tiempos de entrega;

' 36
:36. Retornar { cost, minDays, maxDays, isFree };
stop

@enduml