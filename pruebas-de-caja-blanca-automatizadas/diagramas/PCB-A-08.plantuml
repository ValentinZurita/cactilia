@startuml
!theme plain
skinparam backgroundColor white
skinparam defaultFontName Arial
skinparam defaultFontColor black
skinparam arrowColor black
skinparam shadowing false

title Gestión de Historial de Pedidos

start
:1. Inicio getUserOrderHistory;

if (2. ¿userId válido?) then (No)
  :3. Lanzar error: "Se requiere el ID de usuario";
  stop
else (Sí)
  partition "try {" {
    :4. Extraer y configurar opciones;
    :5. Construir consulta base con userId;
    
    if (6. ¿Se especificó status?) then (Sí)
      :7. Agregar filtro por status;
    else (No)
    endif
    
    :8. Aplicar ordenamiento;
    
    if (9. ¿Existe startAfter?) then (Sí)
      :10. Obtener documento de referencia
      y aplicar paginación si existe;
    else (No)
    endif
    
    :11. Limitar resultados y ejecutar consulta;
    
    if (12. ¿Hay resultados?) then (No)
      :13. Retornar array vacío;
      stop
    else (Sí)
      :14. Transformar documentos
      y retornar resultados;
      stop
    endif
  }
  
  partition "} catch {" {
    :15. Registrar error y lanzar excepción;
    stop
  }
endif

@enduml