@startuml PCB-A-05
!theme plain
skinparam backgroundColor white
skinparam defaultFontName Arial
skinparam defaultFontColor black
skinparam arrowColor black
skinparam shadowing false

title PCB-A-05: Integración con Stripe

start
:1. Inicio createPaymentIntent;

if (2. ¿Usuario autenticado?) then (No)
  :3. Lanzar error de autenticación;
  stop
else (Sí)
  :4. Extraer datos de la solicitud;
  
  if (5. ¿amount válido?) then (No)
    :6. Lanzar error de argumento inválido;
    stop
  else (Sí)
    if (7. ¿paymentMethodId válido?) then (No)
      :8. Lanzar error de argumento inválido;
      stop
    else (Sí)
      try
        :9. Inicializar Stripe con credenciales;
        
        :10. Obtener o crear cliente en Stripe;
        
        :11. Crear Payment Intent en Stripe;
        
        :12. Registrar intento de pago en Firestore;
        
        :13. Retornar clientSecret y paymentIntentId;
      catch
        :14. Registrar error en consola;
        
        :15. Lanzar error HTTP interno;
      endtry
    endif
  endif
endif

stop

@enduml