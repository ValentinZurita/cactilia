@startuml
!theme plain
skinparam backgroundColor white
skinparam defaultFontName Arial
skinparam defaultFontColor black
skinparam arrowColor black
skinparam shadowing false

title Diagrama de Flujo - Cálculo de reglas de envío (PCB-A-07)
start

if (¿rule y products válidos?) then (No)
  :Retornar valores predeterminados;
  stop
else (Sí)
endif

:Calcular subtotal;
:Obtener cost = precio_base;
:Determinar isFree inicial;
:Calcular pesoTotal;

if (¿rule.configuracion_paquetes existe?) then (Sí)
  if (¿Tiene configuración de peso?) then (Sí)
    if (¿pesoTotal > pesoMaximo?) then (Sí)
      :Calcular costo adicional por peso;
    else (No)
    endif
  else (No)
  endif
  
  if (¿Tiene configuración de cantidad?) then (Sí)
    if (¿products.length > maxProductos?) then (Sí)
      :Calcular costo adicional por productos;
    else (No)
    endif
  else (No)
  endif
else (No)
endif

:Obtener minDays y maxDays iniciales;

if (¿Tiene opciones_mensajeria?) then (Sí)
  :Ordenar opciones por precio;
  :Seleccionar opción más económica;
  :Actualizar cost con precio de opción;
  
  if (¿Tiene bestOption.configuracion_paquetes?) then (Sí)
    if (¿pesoTotal > pesoMaximo?) then (Sí)
      :Calcular costo adicional por peso;
    else (No)
    endif
    
    if (¿products.length > maxProductos?) then (Sí)
      :Calcular costo adicional por productos;
    else (No)
    endif
  else (No)
  endif
  
  :Actualizar minDays y maxDays con valores de la opción;
else (No)
endif

if (¿Aplica envío gratis por monto mínimo?) then (Sí)
  :isFree = true;
else (No)
endif

if (¿isFree es true?) then (Sí)
  :cost = 0;
else (No)
endif

if (¿maxDays < minDays?) then (Sí)
  :maxDays = minDays;
else (No)
endif

:Retornar {cost, minDays, maxDays, isFree};
stop
@enduml