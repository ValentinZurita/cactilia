import { useState, useEffect } from 'react';
import { prepareShippingOptionsForCheckout } from '../../../../checkout/services/shippingGroupingService';
import { getUserAddresses } from '../../../../user/services/addressService';

/**
 * Hook personalizado para gestionar las opciones de env√≠o
 * 
 * Proporciona:
 * - Lista de opciones de env√≠o disponibles
 * - Opci√≥n seleccionada actual
 * - Funciones para seleccionar opciones
 * - Estado de carga
 * 
 * @param {Array} cartItems - Items del carrito
 * @param {string} selectedAddressId - ID de la direcci√≥n seleccionada
 * @returns {Object} Estado y funciones para manejar opciones de env√≠o
 */
export const useShippingOptions = (cartItems, selectedAddressId) => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [options, setOptions] = useState([]);
  const [selectedOption, setSelectedOption] = useState(null);
  const [shippingGroups, setShippingGroups] = useState([]);
  const [shippingRules, setShippingRules] = useState([]);
  const [userAddresses, setUserAddresses] = useState([]);
  
  // Cargar direcciones del usuario cuando sea necesario
  useEffect(() => {
    const loadUserAddresses = async () => {
      try {
        // Usamos la funci√≥n global para obtener el ID del usuario
        const userId = window.firebase?.auth()?.currentUser?.uid;
        if (!userId) return;
        
        const { ok, data } = await getUserAddresses(userId);
        if (ok && data) {
          setUserAddresses(data);
        }
      } catch (err) {
        console.error('Error al cargar direcciones:', err);
      }
    };
    
    loadUserAddresses();
  }, []);
  
  // Funci√≥n para obtener una direcci√≥n por su ID
  const getUserAddressById = (addressId) => {
    return userAddresses.find(addr => addr.id === addressId);
  };
  
  // Funci√≥n para generar opciones directamente desde las reglas de env√≠o
  const generateOptionsFromRules = (groups, rules) => {
    console.log('üîç Generando opciones directamente desde reglas:', { 
      groups: groups.length, 
      rules: rules.length 
    });
    
    // Guardar las reglas para referencia
    setShippingRules(rules);
    
    // Si no hay grupos o reglas, no podemos generar opciones
    if (!groups.length || !rules.length) {
      console.warn('‚ùå No hay grupos o reglas para generar opciones');
      return [];
    }
    
    const generatedOptions = [];
    
    // Para cada grupo, crear opciones basadas en sus reglas
    groups.forEach(group => {
      // Si el grupo tiene reglas de env√≠o, usarlas
      if (group.rules && group.rules.length > 0) {
        console.log(`üì¶ Procesando grupo "${group.name}" con ${group.rules.length} reglas`);
        
        group.rules.forEach(rule => {
          console.log(`üö¢ Regla: ${rule.zona} (${rule.id}), opciones de mensajer√≠a:`, rule.opciones_mensajeria?.length || 0);
          
          // Si la regla tiene opciones de mensajer√≠a
          if (rule.opciones_mensajeria && rule.opciones_mensajeria.length > 0) {
            rule.opciones_mensajeria.forEach((opcion, index) => {
              const optionId = `${rule.id}-option-${index}`;
              const price = parseFloat(opcion.precio) || 50;
              
              console.log(`üè∑Ô∏è Creando opci√≥n: ${opcion.nombre || 'Sin nombre'}, precio: ${price}`);
              
              // Crear una opci√≥n formateada para cada opci√≥n de mensajer√≠a
              generatedOptions.push({
                id: optionId,
                label: opcion.nombre || 'Env√≠o est√°ndar',
                carrier: rule.zona || 'Servicio de env√≠o',
                totalCost: price,
                calculatedCost: price,
                minDays: 2,
                maxDays: 7,
                details: `Zona: ${rule.zona || 'Nacional'}`,
                groupsData: [{ 
                  groupId: group.id,
                  option: {
                    id: optionId,
                    calculatedCost: price
                  },
                  items: group.items 
                }]
              });
            });
          } else {
            console.warn(`‚ö†Ô∏è La regla ${rule.zona} no tiene opciones de mensajer√≠a`);
          }
        });
      } else {
        console.warn(`‚ö†Ô∏è El grupo ${group.name} no tiene reglas de env√≠o`);
      }
    });
    
    console.log(`‚úÖ Opciones generadas manualmente: ${generatedOptions.length}`, generatedOptions);
    return generatedOptions;
  };
  
  // Cargar opciones de env√≠o cuando cambia el carrito o la direcci√≥n
  useEffect(() => {
    const fetchShippingOptions = async () => {
      // Si no hay productos o no hay direcci√≥n seleccionada, no calculamos
      if (!cartItems || cartItems.length === 0 || !selectedAddressId) {
        setLoading(false);
        setOptions([]);
        setSelectedOption(null);
        return;
      }
      
      try {
        setLoading(true);
        setError(null);
        
        // Obtener la direcci√≥n completa
        const userAddress = getUserAddressById(selectedAddressId);
        
        if (!userAddress) {
          setError('No se encontr√≥ la direcci√≥n seleccionada');
          setLoading(false);
          return;
        }
        
        console.log('üîÑ Obteniendo opciones de env√≠o para:', {
          productos: cartItems.length,
          direccion: {
            id: selectedAddressId,
            cp: userAddress.zipCode || userAddress.postalCode
          }
        });
        
        // Calcular opciones de env√≠o
        const result = await prepareShippingOptionsForCheckout(cartItems, userAddress);
        console.log('üìä Resultado de prepareShippingOptionsForCheckout:', {
          grupos: result.groups?.length || 0,
          reglas: result.groups?.reduce((count, g) => count + (g.rules?.length || 0), 0) || 0,
          opciones: result.totalOptions?.length || 0
        });
        
        // DIAGN√ìSTICO: Imprimir resultado completo para inspecci√≥n
        console.log('üö® RESULTADO COMPLETO DE SHIPPING OPTIONS:', JSON.stringify(result, null, 2));
        
        // Guardar grupos 
        setShippingGroups(result.groups || []);
        
        // Extraer todas las reglas de los grupos
        const allRules = [];
        if (result.groups && result.groups.length > 0) {
          result.groups.forEach(group => {
            if (group.rules && Array.isArray(group.rules)) {
              group.rules.forEach(rule => {
                if (!allRules.some(r => r.id === rule.id)) {
                  allRules.push(rule);
                }
              });
            }
          });
        }
        
        // Guardar reglas para referencia
        setShippingRules(allRules);
        console.log(`üìè Reglas encontradas: ${allRules.length}`);
        
        // Verificar si tenemos opciones de env√≠o totales
        let formattedOptions = [];
        if (result.totalOptions && result.totalOptions.length > 0) {
          // Transformar opciones para el selector
          formattedOptions = result.totalOptions.map(option => ({
            id: option.id,
            label: option.label,
            carrier: option.carrier,
            totalCost: option.totalCost,
            calculatedCost: option.totalCost, // Para compatibilidad
            minDays: 3, // Valores predeterminados, actualizar cuando tengamos datos reales
            maxDays: 5,
            details: option.groups?.length > 1 
              ? `Env√≠o combinado para ${option.groups.length} grupos de productos` 
              : undefined,
            // Datos completos para uso interno
            groupsData: option.groups
          }));
          
          console.log(`üöö Opciones formateadas desde totalOptions: ${formattedOptions.length}`);
        } else {
          console.warn('‚ö†Ô∏è No hay opciones en totalOptions, generando manualmente desde reglas y grupos');
        }
        
        // Si no hay opciones pero s√≠ hay grupos, generar opciones manualmente
        if (formattedOptions.length === 0 && result.groups && result.groups.length > 0) {
          console.warn('‚ö†Ô∏è FORZANDO GENERACI√ìN MANUAL DE OPCIONES');
          
          // CREAR OPCIONES DIRECTAMENTE DE LOS GRUPOS DE ENV√çO
          const manualOptions = [];
          
          result.groups.forEach(group => {
            if (group.rules && group.rules.length > 0) {
              group.rules.forEach(rule => {
                console.log(`üì¶ Procesando regla: ${rule.id} (${rule.zona || 'Sin nombre'})`);
                console.log('Datos completos de regla:', JSON.stringify(rule, null, 2));
                
                // Si la regla tiene opciones de mensajer√≠a definidas
                if (rule.opciones_mensajeria && rule.opciones_mensajeria.length > 0) {
                  console.log(`üì¨ ${rule.opciones_mensajeria.length} opciones de mensajer√≠a encontradas`);
                  
                  rule.opciones_mensajeria.forEach((opcion, index) => {
                    const optionId = `manual-${rule.id}-option-${index}`;
                    const precio = parseFloat(opcion.precio) || 150;
                    
                    console.log(`üè∑Ô∏è Creando opci√≥n: ${opcion.nombre || 'Sin nombre'}, precio: ${precio}`);
                    
                    manualOptions.push({
                      id: optionId,
                      label: opcion.nombre || `Env√≠o ${rule.zona || 'Est√°ndar'}`,
                      carrier: rule.zona || 'Servicio de env√≠o',
                      totalCost: precio,
                      calculatedCost: precio,
                      minDays: parseInt(opcion.tiempo_entrega?.split('-')[0] || 3, 10),
                      maxDays: parseInt(opcion.tiempo_entrega?.split('-')[1] || 5, 10),
                      details: `Zona: ${rule.zona || 'Nacional'}`,
                      groupsData: [{
                        groupId: group.id,
                        option: {
                          id: optionId,
                          calculatedCost: precio,
                          label: opcion.nombre || `Env√≠o ${rule.zona || 'Est√°ndar'}`
                        },
                        items: group.items
                      }]
                    });
                  });
                } else {
                  // Si no hay opciones de mensajer√≠a, crear una opci√≥n por defecto
                  console.warn(`‚ö†Ô∏è La regla ${rule.id} no tiene opciones de mensajer√≠a, creando opci√≥n por defecto`);
                  
                  const optionId = `default-${rule.id}`;
                  manualOptions.push({
                    id: optionId,
                    label: `Env√≠o ${rule.zona || 'Est√°ndar'}`,
                    carrier: 'Nacional',
                    totalCost: 200,
                    calculatedCost: 200,
                    minDays: 3,
                    maxDays: 5,
                    details: 'Opci√≥n generada autom√°ticamente',
                    groupsData: [{
                      groupId: group.id,
                      option: {
                        id: optionId,
                        calculatedCost: 200,
                        label: `Env√≠o ${rule.zona || 'Est√°ndar'}`
                      },
                      items: group.items
                    }]
                  });
                }
              });
            } else {
              // Si el grupo no tiene reglas, crear una opci√≥n por defecto
              console.warn(`‚ö†Ô∏è El grupo ${group.id} no tiene reglas de env√≠o, creando opci√≥n por defecto`);
              
              const optionId = `default-group-${group.id}`;
              manualOptions.push({
                id: optionId,
                label: 'Env√≠o Est√°ndar',
                carrier: 'Nacional',
                totalCost: 150,
                calculatedCost: 150,
                minDays: 3,
                maxDays: 5,
                details: 'Opci√≥n por defecto',
                groupsData: [{
                  groupId: group.id,
                  option: {
                    id: optionId,
                    calculatedCost: 150,
                    label: 'Env√≠o Est√°ndar'
                  },
                  items: group.items
                }]
              });
            }
          });
          
          console.log(`üöö Opciones generadas manualmente: ${manualOptions.length}`);
          formattedOptions = manualOptions;
        }
        
        console.log(`üö¢ Opciones finales: ${formattedOptions.length}`);
        
        // ASEGURAR QUE SIEMPRE HAYA AL MENOS UNA OPCI√ìN DE ENV√çO
        if (formattedOptions.length === 0) {
          console.warn('‚ö†Ô∏è No se pudieron generar opciones, a√±adiendo opci√≥n por defecto forzada');
          
          formattedOptions = [{
            id: 'default-fallback',
            label: 'Env√≠o Est√°ndar',
            carrier: 'Nacional',
            totalCost: 200,
            calculatedCost: 200,
            minDays: 3,
            maxDays: 5,
            details: 'Opci√≥n por defecto (generada como fallback)'
          }];
        }
        
        // Actualizar estado con las opciones
        setOptions(formattedOptions);
        
        // Seleccionar autom√°ticamente la opci√≥n m√°s econ√≥mica
        if (formattedOptions.length > 0 && !selectedOption) {
          // Ordenar por precio y seleccionar la m√°s barata
          const sortedOptions = [...formattedOptions].sort((a, b) => a.totalCost - b.totalCost);
          console.log(`‚úÖ Seleccionando opci√≥n m√°s econ√≥mica: ${sortedOptions[0].label} ($${sortedOptions[0].totalCost})`);
          setSelectedOption(sortedOptions[0]);
        } else if (formattedOptions.length > 0 && selectedOption) {
          // Mantener la selecci√≥n actual si sigue disponible
          const currentOption = formattedOptions.find(opt => opt.id === selectedOption.id);
          setSelectedOption(currentOption || formattedOptions[0]);
        } else {
          setSelectedOption(null);
        }
      } catch (err) {
        console.error('‚ùå Error al cargar opciones de env√≠o:', err);
        console.error('Detalles del error:', err.stack || err);
        setError('No se pudieron cargar las opciones de env√≠o');
        
        // En caso de error, crear una opci√≥n por defecto
        const fallbackOptions = [{
          id: 'error-fallback',
          label: 'Env√≠o Est√°ndar',
          carrier: 'Nacional',
          totalCost: 200,
          calculatedCost: 200,
          minDays: 3,
          maxDays: 5,
          details: 'Opci√≥n generada por error en c√°lculo'
        }];
        
        setOptions(fallbackOptions);
        setSelectedOption(fallbackOptions[0]);
      } finally {
        setLoading(false);
      }
    };
    
    fetchShippingOptions();
  }, [cartItems, selectedAddressId, userAddresses, selectedOption]);
  
  // Funci√≥n para seleccionar una opci√≥n de env√≠o
  const selectShippingOption = (option) => {
    setSelectedOption(option);
  };
  
  return {
    loading,
    error,
    options,
    selectedOption,
    selectShippingOption,
    shippingGroups,
    shippingRules
  };
}; 